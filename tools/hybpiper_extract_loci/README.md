# HybPiper Extract Loci tool

## Description
This tool was made to extract the loci sequences generated by the Galaxy HybPiper Tool. These files are needed for further phylogenetic analysis so automating the extraction. Therefore, isolation of these files makes sure they can be used in a galaxy workflow or outside of Galaxy for a different purpose the user might need them for.

## Current and future implementations

### Currently working:

* Entire tool has been tested in Galaxy and working as intended.
* Allows for extraction of FNA, FAA and intron sequence files from HybPiper output ZIP archive.
* Sorts extracted sequence files per gene.

### Future plans:
 
* Option to extract the heatmap image from the HybPiper output.

## Files

### *hybpiper_extract_loci.xml*

This file is the galaxy tool wrapper, and basically functions as an interface for the user in the Galaxy environment. It calls the shell script with the correct flags and arguments according to the user's input.

### *extract_loci_sequences.sh*

The shell script is used to call the python script and handle/catch the output and input.
It also extracts and appends the input- and output zip archive files respectively.

Usage:
```console
sh extract_loci_sequences.sh \
-f <HYBPIPER_OUTPUT_LOCATION> \
-o <OUTPUT_LOCATION> \
-t <FILE_TYPE>
```

* **-f** is the path to the hybpiper_output.zip file including the filename and -extention, this is the input file for the tool
* **-o** is the path to the location of the zip archive where the extracted files should go, including the filename and -extention
* **-t** is what file type should be extracted from the HybPiper zipfile. It has three options: 'FNA', 'FAA' and 'intron'.


### *extract_loci_sequences.py*

This python script goes through the extracted HybPiper output file, and locates the sequences folders in each of the sample directories. Then it copies all instances of the user-specified file format from those files to another folder to isolate them. Then the sequence files are sorted per gene by their gene number in the file names.

Usage:
```console
python3 extract_loci_sequences.py \
-f <HYBPIPER_OUTPUT_LOCATION> \
-o <OUTPUT_LOCATION> \
-t <FILE_TYPE>
```

Alternatively:
```console
python3 extract_loci_sequences.py \
--hybpiper_folder <HYBPIPER_OUTPUT_LOCATION> \
--output_folder <OUTPUT_LOCATION> \
--filetype <FILE_TYPE=[FAA/FNA/intron]>
```

* **-f, --hybpiper_output** is the path to the extracted hybpiper archive folder (not the same as with the shell script)
* **-o, --output_folder** is the path to the location of the folder where the user-specified files should be copied to
* **-t, --filetype** is what file type should be extracted from the HybPiper zipfile. It has three options: 'FNA', 'FAA' and 'intron' the default being FNA.

## Dependencies

The following dependencies/requirements are installed by Galaxy using its own Conda environment.
* **Python v3.9**
* **p7zip**

Python 3.9 is used to run the python script, and 7zip is used to open and generate zip files.

## Installation

Make sure this folder containing:

* *hybpiper_extract_loci.xml*
* *extract_loci_sequences.sh*
* *extract_loci_sequences.py*

is put inside the \<Path_To_Your_Galaxy>/tools/ directory in its entirety. \ 
Then make sure all these scripts have the proper permissions by running the commands in the console:

```console
cd \<Path_To_Your_Galaxy>/tools/hybpiper_extract_loci/ 
chmod 755 *
```
The cd command will change the current working directory in the console is the one where the scripts are located.
The chmod command will change the permissions of all files in the current working directory. \
This will give the current user permission to read, write and execute and other users the right to read and write to these files.\
The first 7 is most important as we want Galaxy to have permission to execute the scripts.

Then locate your *'tool_conf.xml'* file. It is usually located at:
\<Path_To_Your_Galaxy>/config/

Once you have found this file, add the following line at the end of the *'tool_conf.xml'* or in one of the categories already present:

```xml
<tool file="<Path_To_Your_Galaxy>/tools/hybpiper_extract_loci/hybpiper_extract_loci.xml" />
```

After this, you can make sure everything is working by starting the Galaxy server.

This is done by navigating to your galaxy folder and runnning the command:
```console
sh run.sh
```

## Things to take into account

* Only use the 'Intron Sequences' option if the 'Run Intronerate' option was used in the HybPiper tool.
In the case intronerate was not run, and this option is used, (presumably) a FileNotFound Error will be raised, and no output will be generated
(introns are generally not sought after during phylogenetic analysis, but the option is there for those who do want or need it).