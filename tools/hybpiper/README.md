# HybPiper Galaxy Tool

## Description
These three scripts form a wrapper for the HybPiper pipeline to be used as a single tool in Galaxy. It takes a ZIP file with reads in FASTQ format and a single FASTA file with target sequences and runs HybPiper. The result is another zip file with all of the output of the HybPiper pipeline.

## Current and future implementations

### Currently working:

* HybPiper Assemble functions
* Generation of FASTA files with enriched Biomarkers

### Future plans:
 
* The inclusion of the generate_heatmap function already available in HybPiper
* The inclusion of the retrieve paralogs functionality  already available in HybPiper

## Files

### *hybpiper_assemble.xml*

This is the Galaxy wrapper. It tells Galaxy what buttons and options to make available in the GUI and makes sure all of the options and arguments entered by the user are properly send to the script. 
It also tells Galaxy to install HybPiper via the chrisjackson-pellicle Conda channel along with other dependencies to make sure they are available for the shell script to use.

### *hybpiper_assemble.sh*

This shell script is the functional code of the wrapper. It makes sure the proper directories, files and arguments to to the right places. 
For example, it activates the _generate_hybpiper_commands.py_ script and reads in the generated commands one by one to execute them. 
Once HybPiper has finished, it makes sure all the output directories generated by that current session are added to a ZIP file and moved to a location where Galaxy can catch it.
Then it cleans up all the temporary files as to not take up too much storage space. 

### *generate_hybpiper_commands.py*

This python script generates the HybPiper commands that one would normally type by hand.\
It creates two files:
* *cmdfile.txt*
* *namelist.txt*

The *cmdfile.txt* contains all the hybpiper commands that the script generated in order (one command for each line), and is iterated through by the shell script in order to execute them one by one.

The *namelist.txt* contains all of the names of the samples that are used for the HybPiper prefixes, that are also used for the names of the output directories, every name is written to a new line in the file.

## Figures
These figures aim to be a visual representation of the aforementioned files and functions.

In these diagrams, the large Squares resemble an environment or instance in which other things are run. 

### Original HybPiper

![Original HybPiper](https://github.com/naturalis/galaxy-pipeline-hybseq/blob/main/images/Visualisation%20Original.png)

* Usually ran through Ubuntu or a Linux-based Operating System
* Reads and target file in Ubuntu directory
* User types in HybPiper commands and specifies where the input files can be found, as well as the optional flags for different results
* HybPiper is installed and run inside a Conda environment and generates its output inside the diretory where the input and output files are located

### HybPiper Galaxy

![HybPiper Galaxy](https://github.com/naturalis/galaxy-pipeline-hybseq/blob/main/images/Visualisation%20Galaxy.png)

* Reads and Target file uploaded to Galaxy Instance and specified in the Galaxy tool
* Options and arguments are also handled by the user in the galaxy tool
* Upon hitting the 'execute' button the options and arguments are sent to the shell script which then ensures the inputs go to the proper locations before running the command generator python script
* Python script generates the HybPiper commands one would normally type out themselves and writes them to a file called 'cmdfile.txt'
* *cmdfile.txt* is then iterated through by the shell script which executes the commands one by one.
* HybPiper is run, as normal, inside the Conda environment and generates its output
* Output is then copied to a ZIP file and caught by Galaxy

## Dependencies

The following dependencies/requirements are installed by Galaxy using its own Conda environment.
* **HybPiper v2.1.2**
* **Python v3.9**
* **Blast**
* **Mafft**
* **p7zip**

These are all only needed to run HybPiper with the exception of Python 3.9, which is also used for the *generate_hybpiper_commands.py* script. 

## Installation

Make sure this folder containing:

* *hybpiper_assemble.xml*
* *hybpiper_assemble.xml*
* *generate_hybpiper_commands.py*

is put inside the \<Path_To_Your_Galaxy>/tools/ directory in its entirety. \ 
Then make sure all these scripts have the proper permissions by running the commands in the console:

```console
cd \<Path_To_Your_Galaxy>/tools/hybpiper/ 
chmod 755 *
```
The cd command will change the current working directory in the console is the one where the scripts are located.
The chmod command will change the permissions of all files in the current working directory. \
This will give the current user permission to read, write and execute and other users the right to read and write to these files.\
The first 7 is most important as we want Galaxy to have permission to execute the scripts.

Then locate your *'tool_conf.xml'* file. It is usually located at:
\<Path_To_Your_Galaxy>/config/

Once you have found this file, add the following line at the end of the *'tool_conf.xml'* or in one of the categories already present:

```xml
<tool file="<Path_To_Your_Galaxy>/tools/hybpiper/hybpiper_assemble.xml" />
```

In order to make sure the Galaxy Conda environment is able to find and install HybPiper, some things need to be changed in Galaxy's config files.

Locate the *dependency_resolvers_conf.xml* file inside your Galaxy folder and replace:
```xml
<conda />
```
With:
```xml
<conda ensure_channels="conda-forge,bioconda,chrisjackson-pellicle" versionless="false" />
```
Then locate your *galaxy.yml* config file in your Galaxy folder. Usually located at:
\<Path_To_Your_Galaxy>/config/

Then add the following line to that config file:

```yml
conda_ensure_channels: iuc,conda-forge,bioconda,chrisjackson-pellicle,defaults
```

This will make sure the chrisjackson-pellicle conda channel is one of the default channels in your Galaxy Conda installation and one of the first places Galaxy looks to install HybPiper from (otherwise it would not be able to find it).

After this, you can make sure everything is working by starting the Galaxy server.

This is done by navigating to your galaxy folder and runnning the command:
```console
sh run.sh
```

## Things to take into account

* Make sure your Galaxy portal server has enough storage space to store the input files twice, due to a current limitation of HybPiper the input files need to be copied to the proper folder as a workaround, which means twice the storage space until the tool finishes its run and the duplicate files are deleted. 
* The input readfiles should be paired reads and should be named something like: \
*'\<samplename\>\_R1\_\<optional_extra_name_parts\>.fastq'* \
*'\<samplename\>\_R2\_\<optional_extra_name_parts\>.fastq'* \
This is to make sure the *generate_hybpiper_commands.py* can properly isolate the first part of the filename so it can use this samplename for the prefix of the output folders.  
So the paired samples should have the same sample name for the part before the first underscore.

## Useful information for developers

* HybPiper, by default, writes most of its print statements and progress bars to the STDERR channel. In the console this is not a problem, however, STDERR also happens to be the default channel Galaxy uses for Error messages. \
So if something is written to STDERR at all, Galaxy will see it as a sign the tool has failed. \
In this tool, this is circumvented by containing the shell code in a codeblock and writing everything to /dev/null, essentially redirecting everything to the void.\
Example:
```shell
(
    <More code here>
    hybpiper asssemble <flags here>
    <More code here>
) > /dev/null 2>&1
```
In the current script, this prevents the issue from happening, the downside to this is that error messages are essentially lost. 
Instead of writing to /dev/null one could write this all to a text file where the error messages could be readt.