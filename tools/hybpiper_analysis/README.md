# HybPiper Analysis Tool

## Description
This tool was made to make the analysis preprocessing steps easier. It unpacks the loci sequences generated by the [Extract Loci tool](https://github.com/naturalis/galaxy-pipeline-hybseq/tree/main/tools/hybpiper_extract_loci "HybPiper extract loci repository"), concatenates them into single fasta files (one for each locus) and then runs MUSCLE for each locus individually. 
The resulting alignment files (in phylip format) are then concatenated into a partitioned supermatrix (phylip) which a txt file with partition information. 
Every file and folder generated by the tool is then archived into a ZIP folder, ready to be downloaded by the user from the Galaxy instance



## Current and future implementations

### Currently working:

* Concatenating fasta files
* Running MUSCLE
* Generating partitioned supermatrix


### Future plans:
 
* The inclusion of additional options for MUSCLE in the Galaxy wrapper so the user has more control over the output.


## Files

### *hybpiper_analysis.xml*

This is the Galaxy wrapper. It tells Galaxy what buttons and options to make available in the GUI and makes sure all of the options and arguments entered by the user are properly send to the script. 
It also tells Galaxy to install Biopython and MUSCLE with their other dependencies to make sure they are available for the shell script to use.

### *hybpiper_analysis.sh*

This shell script is the functional code of the wrapper. It makes sure the proper directories, files and arguments to the right places. 
For example, it activates the _hybpiper_analysis.py_ script to run MUSCLE and concatenate the fasta and phylip files. 
Once the python script is finished, it makes sure its output is copied to Galaxy's dedicated folder and properly caught by the instance. 

Usage:
```console
sh hybpiper_analysis.sh \
-i <INPUT_DIRECTORY> \
-o <OUTPUT_DIRECTORY> \
```

* **-i** is the path to the folder with the extracted loci folders.
* **-o** is the path to the location of the folder where the user-specified files should be generated by the script
* **-f** is the type of sequences the input files are (DNA or AA)

### *hybpiper_analysis.py*

This python script concatenates the fasta files in the input ZIP-file before using Biopython to run MUSCLE to align the loci.
These alignments are then concatenated into a partitioned supermatrix by a specialized function. Lastly, all files generated are outputted into the user-specified output directory.

Usage:
```console
python3 hybpiper_analysis.py -v -h \
-i <INPUT_DIRECTORY> \
-o <OUTPUT_DIRECTORY>
```

Alternatively:
```console
python3 hybpiper_analysis.py --version --help\
--input-dir <INPUT_DIRECTORY> \
--output-dir <OUTPUT_DIRECTORY> \
```

* **-i, --input-dir** is the path to the folder with the extracted loci folders.
* **-o, --output-dir** is the path to the location of the folder where the user-specified files should be generated by the script
* **-f, --format** is the type of sequences the input files are (DNA or AA)

## Dependencies

The following dependencies/requirements are installed by Galaxy using its own Conda environment.
* **Python v3.9**
* **muscle v3.8.31**
* **biopython**
* **p7zip**

Python, MUSCLE and biopython are needed to run the python script, while p7zip is used to uncompress the input file and compress the output.

## Installation

Make sure this folder containing:

* *hybpiper_analysis.xml*
* *hybpiper_analysis.sh*
* *hybpiper_analysis.py*

is put inside the \<Path_To_Your_Galaxy>/tools/ directory in its entirety. 
\
Then make sure all these scripts have the proper permissions by running the commands in the console:

```console
cd \<Path_To_Your_Galaxy>/tools/hybpiper_analysis/ 
chmod 755 *
```
The cd command will change the current working directory in the console is the one where the scripts are located.
The chmod command will change the permissions of all files in the current working directory. \
This will give the current user permission to read, write and execute and other users the right to read and write to these files.\
The first 7 is most important as we want Galaxy to have permission to execute the scripts.

Then locate your *'tool_conf.xml'* file. It is usually located at:
\<Path_To_Your_Galaxy>/config/

Once you have found this file, add the following line at the end of the *'tool_conf.xml'* or in one of the categories already present:

```xml
<tool file="<Path_To_Your_Galaxy>/tools/hybpiper_analysis/hybpiper_analysis.xml" />
```

After this, you can make sure everything is working by starting the Galaxy server.

This is done by navigating to your galaxy folder and runnning the command:
```console
sh run.sh
```

## Things to take into account

* Currently only tested using FNA files and not with FAA files. It hypothethically should work just the same, but further testing is required. 
* There is currently no way to manipulate the MUSCLE settings, as no buttons or sliders are developed in the Galaxy XML file yet. The tool is essentially a black box.
However, one can download the files generated by the hybpiper_extract_loci tool to perform one's own analysis outside of Galaxy. 
* The tool does not generate a Phylogenetic tree, only the partitioned supermatrix and the seperate alignment files. This because phylogenetic inference has many different methods and vieuwpoints by which it is performed.
This way, users have a say in what method they use to generate their phylogenetic trees.


## Useful information for developers

* To be updated when information arises.
